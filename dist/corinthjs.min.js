"use strict";function _typeof2(t){return(_typeof2="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}!function(t,e){"object"===("undefined"==typeof exports?"undefined":_typeof2(exports))&&"undefined"!=typeof module?e(exports,require("node-fetch")):"function"==typeof define&&define.amd?define(["exports","node-fetch"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Corinth={},t.nodeFetch)}(void 0,function(t,e){function n(t){return t&&"object"===_typeof2(t)&&"default"in t?t:{default:t}}var S=n(e);var r,o,i,u,s=(function(t){function e(t){return(e="function"==typeof Symbol&&"symbol"==_typeof2(Symbol.iterator)?function(t){return _typeof2(t)}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":_typeof2(t)})(t)}var n,r;n=void 0,r=function(t){var r,e,n=(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),o=(n(i,e=Error),i);function i(){var t=null!==e&&e.apply(this,arguments)||this;return t.isHaxanError=!0,t}function u(t){return t&&!0===t.isHaxanError}var s,h=(n(a,s=o),a);function a(){var t=s.call(this)||this;return t.isTimeout=!0,t}var c,d=(n(p,c=o),p);function p(t){var e=c.call(this)||this;return e.isRejection=!0,e.response=t,e}var f,y,v,b=(n(l,f=o),l);function l(){var t=f.call(this)||this;return t.isAbort=!0,t}(n=y={}).Auto="auto",n.Json="json",n.Text="text",n.Stream="stream",(n=v=v||{}).Get="GET",n.Post="POST",n.Put="PUT",n.Patch="PATCH",n.Delete="DELETE",n.Head="HEAD",n.Options="OPTIONS";function w(t,u,s,a){return new(s=s||Promise)(function(n,e){function r(t){try{i(a.next(t))}catch(t){e(t)}}function o(t){try{i(a.throw(t))}catch(t){e(t)}}function i(t){var e;t.done?n(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(r,o)}i((a=a.apply(t,u||[])).next())})}function m(n,r){var o,i,u,s={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(u=2&e[0]?i.return:e[0]?i.throw||((u=i.return)&&u.call(i),0):i.next)&&!(u=u.call(i,e[1])).done)return u;switch(i=0,(e=u?[2&e[0],u.value]:e)[0]){case 0:case 1:u=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,i=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(u=0<(u=s.trys).length&&u[u.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!u||e[1]>u[0]&&e[1]<u[3])){s.label=e[1];break}if(6===e[0]&&s.label<u[1]){s.label=u[1],u=e;break}if(u&&s.label<u[2]){s.label=u[2],s.ops.push(e);break}u[2]&&s.ops.pop(),s.trys.pop();continue}e=r.call(n,s)}catch(t){e=[6,t],i=0}finally{o=u=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}var _=Object.freeze({__proto__:null,HaxanError:o,isHaxanError:u,HaxanTimeout:h,isHaxanTimeout:function(t){return u(t)&&!0===t.isTimeout},HaxanRejection:d,isHaxanRejection:function(t){return u(t)&&!0===t.isRejection},HaxanAbort:b,isHaxanAbort:function(t){return u(t)&&!0===t.isAbort},get ResponseType(){return y},get HTTPMethod(){return v}}),g=function(){return(g=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},x=(P.prototype.setProp=function(t,e){return this._opts[t]=e,this},P.prototype.rejectOn=function(t){return this.setProp("rejectOn",t)},P.prototype.url=function(t){return this.setProp("url",t)},P.prototype.type=function(t){return this.setProp("type",t)},P.prototype.method=function(t){return this.setProp("method",t)},P.prototype.get=function(){return this.method("GET")},P.prototype.head=function(){return this.method("HEAD")},P.prototype.options=function(){return this.method("OPTIONS")},P.prototype.post=function(t){return this.body(t).method("POST")},P.prototype.put=function(t){return this.body(t).method("PUT")},P.prototype.patch=function(t){return this.body(t).method("PATCH")},P.prototype.delete=function(){return this.method("DELETE")},P.prototype.body=function(t){return this.setProp("body",t)},P.prototype.header=function(t,e){return this._opts.headers[t]=e,this},P.prototype.param=function(t,e){return this._opts.query[t]=e,this},P.prototype.timeout=function(t){return this.setProp("timeout",t)},P.prototype.abort=function(t){return this.setProp("abortSignal",t)},P.prototype.normalizedBody=function(){var t=this._opts.body;return null===t?null:"string"==typeof t?t:JSON.stringify(t)},P.prototype.parseBody=function(n){return w(this,void 0,void 0,function(){var e;return m(this,function(t){switch(t.label){case 0:return(e=n.headers.get("content-type"))&&e.startsWith("application/json")?[4,n.json()]:[3,2];case 1:return[2,t.sent()];case 2:return[4,n.text()];case 3:return[2,t.sent()]}})})},P.prototype.getOptions=function(){return this._opts},P.prototype.send=function(){return this.execute()},P.prototype.execute=function(){return this.request()},P.prototype.request=function(){return w(this,void 0,void 0,function(){var o,i,u,s,a,c,p,f,l=this;return m(this,function(t){switch(t.label){case 0:return t.trys.push([0,9,,10]),o=void 0,i="undefined"!=typeof window&&"[object Window]"==={}.toString.call(window),o=i?fetch:S.default,u=Object.keys(this._opts.query).length?this._opts.url+"?"+(r=this._opts.query,Object.keys(r).map(function(t){return t+"="+String(r[t])}).join("&")):this._opts.url,[4,Promise.race([o(u,{method:this._opts.method,headers:g(g({"Content-Type":"application/json"},this._opts.headers),{"User-Agent":"Haxan 0.2.1"}),body:(e=this._opts.method,[v.Put,v.Post,v.Patch].includes(e.toUpperCase())?this.normalizedBody():void 0),signal:this._opts.abortSignal}),new Promise(function(t,e){return setTimeout(function(){return e(new h)},l._opts.timeout)})])];case 1:if(s=t.sent(),this._opts.rejectOn(s.status))throw new d(s);return e=s.headers,n={},e.forEach(function(t,e){n[e]=t}),a=n,this._opts.type!==y.Auto?[3,3]:(c={},[4,this.parseBody(s)]);case 2:return[2,(c.data=t.sent(),c.ok=s.ok,c.status=s.status,c.headers=a,c)];case 3:return this._opts.type!==y.Json?[3,5]:(p={},[4,s.json()]);case 4:return[2,(p.data=t.sent(),p.ok=s.ok,p.status=s.status,p.headers=a,p)];case 5:return this._opts.type!==y.Text?[3,7]:(f={},[4,s.text()]);case 6:return[2,(f.data=t.sent(),f.ok=s.ok,f.status=s.status,f.headers=a,f)];case 7:if(this._opts.type===y.Stream&&!i)return[2,{data:s.body,ok:s.ok,status:s.status,headers:a}];t.label=8;case 8:throw new Error("No valid response body parsing method found");case 9:if("AbortError"===(a=t.sent()).name)throw new b;throw a;case 10:return[2]}var n,e,r})})},P);function P(t,e){this._opts={url:"",headers:{},query:{},method:v.Get,body:void 0,type:y.Auto,rejectOn:function(){return!1},abortSignal:void 0,timeout:3e4},e&&Object.assign(this._opts,e),this.url(t)}function k(t,e){return new x(t,e)}o=function(){var t,e=k;for(t in _)e[t]=_[t];return e.HaxanFactory=x,e}(),t.HaxanFactory=x,t.default=o,Object.defineProperty(t,"__esModule",{value:!0})},"object"===e(t)?r(t):r((n="undefined"!=typeof globalThis?globalThis:n||self).Haxan={})}((r={exports:{}},r.exports)),r.exports),a=(o=s)&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o,c=(i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),p=(u=Error,c(f,u),f);function f(t){var e=u.call(this)||this;return e.isCorinthError=!0,e.res=t,e}var l=function(t,u,s,a){return new(s=s||Promise)(function(n,e){function r(t){try{i(a.next(t))}catch(t){e(t)}}function o(t){try{i(a.throw(t))}catch(t){e(t)}}function i(t){var e;t.done?n(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(r,o)}i((a=a.apply(t,u||[])).next())})},h=function(n,r){var o,i,u,s={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(u=2&e[0]?i.return:e[0]?i.throw||((u=i.return)&&u.call(i),0):i.next)&&!(u=u.call(i,e[1])).done)return u;switch(i=0,(e=u?[2&e[0],u.value]:e)[0]){case 0:case 1:u=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,i=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(u=0<(u=s.trys).length&&u[u.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!u||e[1]>u[0]&&e[1]<u[3])){s.label=e[1];break}if(6===e[0]&&s.label<u[1]){s.label=u[1],u=e;break}if(u&&s.label<u[2]){s.label=u[2],s.ops.push(e);break}u[2]&&s.ops.pop(),s.trys.pop();continue}e=r.call(n,s)}catch(t){e=[6,t],i=0}finally{o=u=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}},d=(y.prototype.getName=function(){return this.name},y.prototype.uri=function(){return this.$root.getIp()+"/queue/"+this.name},y.prototype.getUrl=function(t){return this.uri()+t},y.prototype.ack=function(n){return l(this,void 0,void 0,function(){var e;return h(this,function(t){switch(t.label){case 0:return[4,a(this.getUrl("/"+n+"/ack")).method(a.HTTPMethod.Post).send()];case 1:if((e=t.sent()).ok)return[2,!0];throw new p(e)}})})},y.prototype.peek=function(){return l(this,void 0,void 0,function(){var e;return h(this,function(t){switch(t.label){case 0:return[4,a(this.getUrl("/peek")).send()];case 1:if((e=t.sent()).ok)return[2,e.data.result.item||null];throw new p(e)}})})},y.prototype.dequeue=function(t){var e=void 0===t?{}:t,t=e.ack,r=void 0!==t&&t,e=e.amount,o=void 0===e?1:e;return l(this,void 0,void 0,function(){var e,n=this;return h(this,function(t){switch(t.label){case 0:return e=a(this.getUrl("/dequeue")).method(a.HTTPMethod.Post).param("amount",o),r&&e.param("ack","true"),[4,e.send()];case 1:if((e=t.sent()).ok)return[2,e.data.result.items.map(function(e){return{message:e,ack:function(){return l(n,void 0,void 0,function(){return h(this,function(t){return r?[2,!0]:[2,this.ack(e.id)]})})}}})];throw new p(e)}})})},y.prototype.enqueueOne=function(e,n){return void 0===n&&(n=null),l(this,void 0,void 0,function(){return h(this,function(t){return[2,this.enqueue([{item:e,deduplication:n}])]})})},y.prototype.enqueue=function(n){return l(this,void 0,void 0,function(){var e;return h(this,function(t){switch(t.label){case 0:return[4,a(this.getUrl("/enqueue")).post({messages:n}).send()];case 1:if((e=t.sent()).ok)return[2,e.data.result];throw new p(e)}})})},y.prototype.stat=function(){return l(this,void 0,void 0,function(){var e;return h(this,function(t){switch(t.label){case 0:return[4,a(this.uri()).send()];case 1:if((e=t.sent()).ok)return[2,e.data.result.queue];throw new p(e)}})})},y.prototype.size=function(){return l(this,void 0,void 0,function(){return h(this,function(t){switch(t.label){case 0:return[4,this.stat()];case 1:return[2,t.sent().size]}})})},y.prototype.purge=function(){return l(this,void 0,void 0,function(){var e;return h(this,function(t){switch(t.label){case 0:return[4,a(this.getUrl("/purge")).delete().send()];case 1:if((e=t.sent()).ok)return[2,!0];throw new p(e)}})})},y.prototype.edit=function(e){return l(this,void 0,void 0,function(){return h(this,function(t){return[2,this.update(e)]})})},y.prototype.update=function(n){return l(this,void 0,void 0,function(){var e;return h(this,function(t){switch(t.label){case 0:return[4,a(this.uri()).patch(n).send()];case 1:if((e=t.sent()).ok)return[2,!0];throw new p(e)}})})},y.prototype.exists=function(){return l(this,void 0,void 0,function(){var e;return h(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,this.stat()];case 1:return t.sent(),[2,!0];case 2:if((e=t.sent()).isCorinthError&&404===e.res.status)return[2,!1];throw e;case 3:return[2]}})})},y.prototype.delete=function(){return l(this,void 0,void 0,function(){var e;return h(this,function(t){switch(t.label){case 0:return[4,a(this.uri()).delete().send()];case 1:if((e=t.sent()).ok)return[2,!0];throw new p(e)}})})},y.prototype.create=function(n){return l(this,void 0,void 0,function(){var e;return h(this,function(t){switch(t.label){case 0:return e=a(this.uri()).method(a.HTTPMethod.Put),void 0!==(null==n?void 0:n.dead_letter_queue)&&e.param("dead_letter_queue_name",n.dead_letter_queue.getName()),void 0!==(null==n?void 0:n.dead_letter_queue_threshold)&&e.param("dead_letter_queue_threshold",String(n.dead_letter_queue_threshold)),void 0!==(null==n?void 0:n.deduplication_time)&&e.param("deduplication_time",String(n.deduplication_time)),void 0!==(null==n?void 0:n.max_length)&&e.param("max_length",String(n.max_length)),void 0!==(null==n?void 0:n.persistent)&&e.param("persistent",String(n.persistent)),void 0!==(null==n?void 0:n.requeue_time)&&e.param("requeue_time",String(n.requeue_time)),[4,e.send()];case 1:if((e=t.sent()).ok)return[2,!0];throw new p(e)}})})},y.prototype.ensure=function(n){return l(this,void 0,void 0,function(){var e;return h(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,this.create(n)];case 1:return[2,t.sent()];case 2:if((e=t.sent()).isCorinthError&&409===e.res.status)return[2,!0];throw e;case 3:return[2]}})})},y);function y(t,e){this.$root=t,this.name=e}var v=function(t,u,s,a){return new(s=s||Promise)(function(n,e){function r(t){try{i(a.next(t))}catch(t){e(t)}}function o(t){try{i(a.throw(t))}catch(t){e(t)}}function i(t){var e;t.done?n(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(r,o)}i((a=a.apply(t,u||[])).next())})},b=function(n,r){var o,i,u,s={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(u=2&e[0]?i.return:e[0]?i.throw||((u=i.return)&&u.call(i),0):i.next)&&!(u=u.call(i,e[1])).done)return u;switch(i=0,(e=u?[2&e[0],u.value]:e)[0]){case 0:case 1:u=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,i=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(u=0<(u=s.trys).length&&u[u.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!u||e[1]>u[0]&&e[1]<u[3])){s.label=e[1];break}if(6===e[0]&&s.label<u[1]){s.label=u[1],u=e;break}if(u&&s.label<u[2]){s.label=u[2],s.ops.push(e);break}u[2]&&s.ops.pop(),s.trys.pop();continue}e=r.call(n,s)}catch(t){e=[6,t],i=0}finally{o=u=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}},e=(w.prototype.getIp=function(){return this.ip},w.prototype.uri=function(t){return""+this.ip+t},w.prototype.version=function(){return v(this,void 0,void 0,function(){return b(this,function(t){switch(t.label){case 0:return[4,this.stat()];case 1:return[2,t.sent().version]}})})},w.prototype.stat=function(){return v(this,void 0,void 0,function(){var e;return b(this,function(t){switch(t.label){case 0:return[4,a(this.uri("/")).send()];case 1:if((e=t.sent()).ok)return[2,e.data.result.info];throw new p(e)}})})},w.prototype.listQueues=function(){return v(this,void 0,void 0,function(){var e;return b(this,function(t){switch(t.label){case 0:return[4,a(this.uri("/queues")).send()];case 1:if((e=t.sent()).ok)return[2,e.data.result.queues.items];throw new p(e)}})})},w.prototype.queueExists=function(e){return v(this,void 0,void 0,function(){return b(this,function(t){return[2,new d(this,e).exists()]})})},w.prototype.defineQueue=function(t){return new d(this,t)},w);function w(t){this.ip=t}t.MessageState=void 0,(c=t.MessageState||(t.MessageState={}))[c.Pending=0]="Pending",c[c.Requeued=1]="Requeued",t.Corinth=e,t.CorinthError=p,t.Queue=d,Object.defineProperty(t,"__esModule",{value:!0})});
